name: Fedlin Azure Secure CI/CD

on:
  push:
    branches: [ "main" ]
    paths:
      - "scripts/**"
      - ".github/workflows/deploy-azure.yml"
  workflow_dispatch:

permissions:
  id-token: write     # for OIDC
  contents: read

concurrency:
  group: fedlin-azure-secure-cicd-${{ github.ref }}
  cancel-in-progress: true

env:
  REGION: centralus
  VM_SIZE: Standard_B1s              # Free tier eligible (subject to Azure free acct terms)
  RG: fedlin-cicd-lab
  LAW: fedlin-law
  DCR: fedlin-dcr
  VNET: fedlin-vnet
  SUBNET: fedlin-subnet
  NSG: fedlin-nsg
  PIP: fedlin-pip
  NIC: fedlin-nic
  VM: fedlin-vm
  ADMIN_USERNAME: azureuser
  SSH_KEY_PATH: ~/.ssh/id_rsa
  TAG_OWNER: "Fedlin"
  TAG_ENV: "lab"
  TAG_PROJECT: "fedlin-azure-secure-cicd"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup ShellCheck
        uses: ludeeus/action-shellcheck@2.0.0

      - name: Lint scripts
        run: |
          shellcheck scripts/*.sh

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Azure CLI version
        uses: azure/cli@v2
        with:
          inlineScript: |
            az version

      - name: Deploy infrastructure
        run: |
          bash scripts/az_deploy.sh

      - name: Collect evidence (describe resources)
        run: |
          mkdir -p artifacts
          az group show -n "$RG" -o json > artifacts/rg.json
          az monitor log-analytics workspace show -g "$RG" -n "$LAW" -o json > artifacts/law.json
          az monitor data-collection rule show -g "$RG" -n "$DCR" -o json > artifacts/dcr.json
          az vm show -g "$RG" -n "$VM" -o json > artifacts/vm.json
          az network nsg show -g "$RG" -n "$NSG" -o json > artifacts/nsg.json
          az network vnet show -g "$RG" -n "$VNET" -o json > artifacts/vnet.json
          az network nic show -g "$RG" -n "$NIC" -o json > artifacts/nic.json

      - name: Upload CI Evidence
        uses: actions/upload-artifact@v4
        with:
          name: fedlin-azure-evidence
          path: artifacts/
          if-no-files-found: error
