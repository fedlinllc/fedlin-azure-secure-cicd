name: Fedlin Azure Secure CI/CD

on:
  push:
    branches: [ "main" ]
    paths:
      - "scripts/**"
      - ".github/workflows/deploy-azure.yml"
  workflow_dispatch:

permissions:
  id-token: write   # required for OIDC
  contents: read

concurrency:
  group: fedlin-azure-secure-cicd
  cancel-in-progress: false

env:
  REGION: centralus
  RESOURCE_PREFIX: fedlin
  VM_SIZE: Standard_B1s
  SSH_USERNAME: fedlin
  MY_IP: "*"            # tighten to your /32 later
  ENABLE_HTTP: "false"  # set "true" to allow 80/443 in NSG

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Azure CLI context
        run: |
          set -euo pipefail
          az account show
          az --version

      - name: Deploy Azure resources
        env:
          REGION: ${{ env.REGION }}
          RESOURCE_PREFIX: ${{ env.RESOURCE_PREFIX }}
          VM_SIZE: ${{ env.VM_SIZE }}
          SSH_USERNAME: ${{ env.SSH_USERNAME }}
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
          MY_IP: ${{ env.MY_IP }}
          ENABLE_HTTP: ${{ env.ENABLE_HTTP }}
        run: |
          bash scripts/az_deploy.sh

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fedlin-azure-deploy-outputs
          path: outputs/
          if-no-files-found: warn
